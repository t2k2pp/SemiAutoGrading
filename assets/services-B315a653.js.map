{"version":3,"file":"services-B315a653.js","sources":["../../src/services/dataService.ts","../../src/services/llmService.ts"],"sourcesContent":["import type { Exam, Question, Answer, GradingResult, LLMConfig } from '../contexts/SimpleAppContext';\n\n// IndexedDB設定\nconst DB_NAME = 'IPAGraderDB';\nconst DB_VERSION = 1;\n\n// オブジェクトストア名\nconst STORES = {\n  EXAMS: 'exams',\n  QUESTIONS: 'questions',\n  ANSWERS: 'answers',\n  GRADING_RESULTS: 'gradingResults',\n};\n\n// LocalStorage キー\nconst STORAGE_KEYS = {\n  LLM_CONFIG: 'ipa-grader-llm-config',\n  UI_SETTINGS: 'ipa-grader-ui-settings',\n};\n\nclass DataService {\n  private db: IDBDatabase | null = null;\n\n  // IndexedDB初期化\n  async initDB(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n      request.onerror = () => {\n        reject(new Error('IndexedDB初期化に失敗しました'));\n      };\n\n      request.onsuccess = () => {\n        this.db = request.result;\n        resolve();\n      };\n\n      request.onupgradeneeded = (event) => {\n        const db = (event.target as IDBOpenDBRequest).result;\n\n        // Examsストア\n        if (!db.objectStoreNames.contains(STORES.EXAMS)) {\n          const examStore = db.createObjectStore(STORES.EXAMS, { keyPath: 'id' });\n          examStore.createIndex('name', 'name', { unique: false });\n          examStore.createIndex('createdAt', 'createdAt', { unique: false });\n        }\n\n        // Questionsストア\n        if (!db.objectStoreNames.contains(STORES.QUESTIONS)) {\n          const questionStore = db.createObjectStore(STORES.QUESTIONS, { keyPath: 'id' });\n          questionStore.createIndex('examId', 'examId', { unique: false });\n          questionStore.createIndex('number', 'number', { unique: false });\n        }\n\n        // Answersストア\n        if (!db.objectStoreNames.contains(STORES.ANSWERS)) {\n          const answerStore = db.createObjectStore(STORES.ANSWERS, { keyPath: 'id' });\n          answerStore.createIndex('examId', 'examId', { unique: false });\n          answerStore.createIndex('studentId', 'studentId', { unique: false });\n          answerStore.createIndex('questionId', 'questionId', { unique: false });\n        }\n\n        // GradingResultsストア\n        if (!db.objectStoreNames.contains(STORES.GRADING_RESULTS)) {\n          const resultStore = db.createObjectStore(STORES.GRADING_RESULTS, { keyPath: 'id' });\n          resultStore.createIndex('answerId', 'answerId', { unique: true });\n        }\n      };\n    });\n  }\n\n  // 汎用的なIndexedDB操作メソッド\n  private async performDBOperation<T>(\n    storeName: string,\n    operation: (store: IDBObjectStore) => IDBRequest<T>\n  ): Promise<T> {\n    if (!this.db) {\n      throw new Error('データベースが初期化されていません');\n    }\n\n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([storeName], 'readwrite');\n      const store = transaction.objectStore(storeName);\n      const request = operation(store);\n\n      request.onsuccess = () => resolve(request.result);\n      request.onerror = () => reject(new Error(`データベース操作に失敗しました: ${request.error}`));\n    });\n  }\n\n  private async performDBReadOperation<T>(\n    storeName: string,\n    operation: (store: IDBObjectStore) => IDBRequest<T>\n  ): Promise<T> {\n    if (!this.db) {\n      throw new Error('データベースが初期化されていません');\n    }\n\n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([storeName], 'readonly');\n      const store = transaction.objectStore(storeName);\n      const request = operation(store);\n\n      request.onsuccess = () => resolve(request.result);\n      request.onerror = () => reject(new Error(`データベース読み取りに失敗しました: ${request.error}`));\n    });\n  }\n\n  // Exam関連操作\n  async saveExam(exam: Exam): Promise<void> {\n    await this.performDBOperation(STORES.EXAMS, store => store.put(exam));\n\n    // 関連する質問も保存\n    for (const question of exam.questions) {\n      await this.saveQuestion(question);\n    }\n  }\n\n  async getExam(id: string): Promise<Exam | null> {\n    const exam = await this.performDBReadOperation(STORES.EXAMS, store => store.get(id));\n    if (!exam) return null;\n\n    // 質問を取得\n    const questions = await this.getQuestionsByExamId(id);\n    return { ...exam, questions };\n  }\n\n  async getAllExams(): Promise<Exam[]> {\n    const exams = await this.performDBReadOperation(STORES.EXAMS, store => store.getAll());\n\n    // 各試験の質問を取得\n    const examsWithQuestions: Exam[] = [];\n    for (const exam of exams) {\n      const questions = await this.getQuestionsByExamId(exam.id);\n      examsWithQuestions.push({ ...exam, questions });\n    }\n\n    return examsWithQuestions;\n  }\n\n  async deleteExam(id: string): Promise<void> {\n    await this.performDBOperation(STORES.EXAMS, store => store.delete(id));\n\n    // 関連データも削除\n    const questions = await this.getQuestionsByExamId(id);\n    for (const question of questions) {\n      await this.deleteQuestion(question.id);\n    }\n\n    const answers = await this.getAnswersByExamId(id);\n    for (const answer of answers) {\n      await this.deleteAnswer(answer.id);\n    }\n  }\n\n  // Question関連操作\n  async saveQuestion(question: Question): Promise<void> {\n    await this.performDBOperation(STORES.QUESTIONS, store => store.put(question));\n  }\n\n  async getQuestion(id: string): Promise<Question | null> {\n    return await this.performDBReadOperation(STORES.QUESTIONS, store => store.get(id));\n  }\n\n  async getQuestionsByExamId(examId: string): Promise<Question[]> {\n    return await this.performDBReadOperation(STORES.QUESTIONS, store => {\n      const index = store.index('examId');\n      return index.getAll(examId);\n    });\n  }\n\n  async deleteQuestion(id: string): Promise<void> {\n    await this.performDBOperation(STORES.QUESTIONS, store => store.delete(id));\n  }\n\n  // Answer関連操作\n  async saveAnswer(answer: Answer): Promise<void> {\n    await this.performDBOperation(STORES.ANSWERS, store => store.put(answer));\n  }\n\n  async getAnswer(id: string): Promise<Answer | null> {\n    return await this.performDBReadOperation(STORES.ANSWERS, store => store.get(id));\n  }\n\n  async getAnswersByExamId(examId: string): Promise<Answer[]> {\n    return await this.performDBReadOperation(STORES.ANSWERS, store => {\n      const index = store.index('examId');\n      return index.getAll(examId);\n    });\n  }\n\n  async getAnswersByStudentId(studentId: string): Promise<Answer[]> {\n    return await this.performDBReadOperation(STORES.ANSWERS, store => {\n      const index = store.index('studentId');\n      return index.getAll(studentId);\n    });\n  }\n\n  async deleteAnswer(id: string): Promise<void> {\n    await this.performDBOperation(STORES.ANSWERS, store => store.delete(id));\n\n    // 関連する採点結果も削除\n    const gradingResult = await this.getGradingResultByAnswerId(id);\n    if (gradingResult) {\n      await this.deleteGradingResult(gradingResult.id);\n    }\n  }\n\n  // GradingResult関連操作\n  async saveGradingResult(result: GradingResult): Promise<void> {\n    await this.performDBOperation(STORES.GRADING_RESULTS, store => store.put(result));\n  }\n\n  async getGradingResult(id: string): Promise<GradingResult | null> {\n    return await this.performDBReadOperation(STORES.GRADING_RESULTS, store => store.get(id));\n  }\n\n  async getGradingResultByAnswerId(answerId: string): Promise<GradingResult | null> {\n    return await this.performDBReadOperation(STORES.GRADING_RESULTS, store => {\n      const index = store.index('answerId');\n      return index.get(answerId);\n    });\n  }\n\n  async getAllGradingResults(): Promise<GradingResult[]> {\n    return await this.performDBReadOperation(STORES.GRADING_RESULTS, store => store.getAll());\n  }\n\n  async deleteGradingResult(id: string): Promise<void> {\n    await this.performDBOperation(STORES.GRADING_RESULTS, store => store.delete(id));\n  }\n\n  // LocalStorage操作（設定など）\n  saveLLMConfig(config: LLMConfig): void {\n    localStorage.setItem(STORAGE_KEYS.LLM_CONFIG, JSON.stringify(config));\n  }\n\n  getLLMConfig(): LLMConfig | null {\n    const configStr = localStorage.getItem(STORAGE_KEYS.LLM_CONFIG);\n    return configStr ? JSON.parse(configStr) : null;\n  }\n\n  saveUISettings(settings: Record<string, any>): void {\n    localStorage.setItem(STORAGE_KEYS.UI_SETTINGS, JSON.stringify(settings));\n  }\n\n  getUISettings(): Record<string, any> | null {\n    const settingsStr = localStorage.getItem(STORAGE_KEYS.UI_SETTINGS);\n    return settingsStr ? JSON.parse(settingsStr) : null;\n  }\n\n  // データクリア\n  async clearAllData(): Promise<void> {\n    if (!this.db) return;\n\n    const storeNames = [STORES.EXAMS, STORES.QUESTIONS, STORES.ANSWERS, STORES.GRADING_RESULTS];\n\n    for (const storeName of storeNames) {\n      await this.performDBOperation(storeName, store => store.clear());\n    }\n  }\n\n  clearLocalStorage(): void {\n    Object.values(STORAGE_KEYS).forEach(key => {\n      localStorage.removeItem(key);\n    });\n  }\n\n  // データベース接続確認\n  isConnected(): boolean {\n    return this.db !== null;\n  }\n\n  // データベースクローズ\n  close(): void {\n    if (this.db) {\n      this.db.close();\n      this.db = null;\n    }\n  }\n}\n\n// シングルトンインスタンス\nexport const dataService = new DataService();","import type { LLMConfig, Question, Answer, SubQuestion } from '../contexts/SimpleAppContext';\n\ninterface LLMGradingResponse {\n  score: '○' | '△' | '×';\n  points: number;\n  reason: string;\n  confidence?: number;\n}\n\ninterface GradingPrompt {\n  systemPrompt: string;\n  questionContext: string;\n  answerToGrade: string;\n  gradingCriteria: string;\n}\n\nexport class LLMService {\n  private config: LLMConfig;\n\n  constructor(config: LLMConfig) {\n    this.config = config;\n  }\n\n  // 設定更新\n  updateConfig(config: LLMConfig): void {\n    this.config = config;\n  }\n\n  // LM Studio接続テスト\n  async testConnection(): Promise<boolean> {\n    try {\n      const response = await fetch(`${this.config.endpoint}/models`, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        signal: AbortSignal.timeout(this.config.timeout),\n      });\n\n      return response.ok;\n    } catch (error) {\n      console.error('LM Studio接続テストに失敗:', error);\n      return false;\n    }\n  }\n\n  // 利用可能なモデル一覧取得\n  async getAvailableModels(): Promise<string[]> {\n    try {\n      const response = await fetch(`${this.config.endpoint}/models`, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        signal: AbortSignal.timeout(this.config.timeout),\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      return data.data?.map((model: any) => model.id) || [];\n    } catch (error) {\n      console.error('モデル一覧取得に失敗:', error);\n      throw new Error('モデル一覧の取得に失敗しました');\n    }\n  }\n\n  // 採点プロンプト生成\n  private generateGradingPrompt(subQuestion: SubQuestion, answer: Answer): GradingPrompt {\n    const systemPrompt = `You are a grader for the IPA Project Manager certification exam.\nGrade the answer according to the following criteria and return the result in JSON format.\n\nGrading criteria:\n- ○: Equivalent to the sample answer (meets 80% or more elements)\n- △: Partially correct (meets 50-79% of elements)\n- ×: Incorrect or off-topic (less than 50%)\n\nReturn the output in the following JSON format:\n{\n  \"score\": \"○\" | \"△\" | \"×\",\n  \"points\": numeric_score,\n  \"reason\": \"grading_reason_within_100_chars\"\n}`;\n\n    const questionContext = `QUESTION:\n${subQuestion.content}\n\nQUESTION INTENT:\n${subQuestion.intention}\n\nSAMPLE ANSWER:\n${subQuestion.sampleAnswer}\n\nMAX SCORE: ${subQuestion.maxScore} points`;\n\n    const answerToGrade = `STUDENT ANSWER TO GRADE:\nStudent ID: ${answer.studentId}\nAnswer Content: ${answer.content}`;\n\n    const gradingCriteria = `GRADING CRITERIA:\n- Does the answer accurately understand the question requirements?\n- Does the answer align with the question intent?\n- How much does the answer include elements from the sample answer?\n- Are appropriate PM knowledge and expressions used?\n- Is the content logical and consistent?`;\n\n    return {\n      systemPrompt,\n      questionContext,\n      answerToGrade,\n      gradingCriteria,\n    };\n  }\n\n  // LLMを使った採点実行\n  async gradeAnswer(subQuestion: SubQuestion, answer: Answer): Promise<LLMGradingResponse> {\n    const prompt = this.generateGradingPrompt(subQuestion, answer);\n\n    const userPrompt = `${prompt.questionContext}\n\n${prompt.answerToGrade}\n\n${prompt.gradingCriteria}\n\nPlease grade the student answer based on the above information and return the result in JSON format.`;\n\n    try {\n      let url = '';\n      let headers: Record<string, string> = {\n        'Content-Type': 'application/json',\n      };\n      let requestBody: any = {\n        model: this.config.model,\n        messages: [\n          {\n            role: 'system',\n            content: prompt.systemPrompt,\n          },\n          {\n            role: 'user',\n            content: userPrompt,\n          },\n        ],\n        temperature: this.config.temperature\n      };\n\n      // 最大トークン数制限を使用する場合のみ追加\n      if (this.config.useMaxTokens) {\n        requestBody.max_tokens = this.config.maxTokens;\n      }\n\n      // プロバイダー別の設定\n      switch (this.config.provider) {\n        case 'lm-studio':\n          url = `${this.config.endpoint}/chat/completions`;\n          headers['Authorization'] = 'Bearer dummy-key';\n          break;\n\n        case 'ollama':\n          url = `${this.config.ollamaHost || this.config.endpoint}/v1/chat/completions`;\n          break;\n\n        case 'azure-openai':\n          if (this.config.apiVersion?.includes('v1')) {\n            // New v1 API format\n            url = `${this.config.endpoint}/openai/v1/chat/completions`;\n          } else {\n            // Traditional format\n            url = `${this.config.endpoint}/openai/deployments/${this.config.deploymentId}/chat/completions?api-version=${this.config.apiVersion}`;\n          }\n          if (this.config.apiKey) {\n            headers['api-key'] = this.config.apiKey;\n          }\n          break;\n\n        case 'gemini':\n          // Convert to Gemini format\n          url = `${this.config.endpoint}/models/${this.config.model}:generateContent`;\n          if (this.config.geminiApiKey) {\n            headers['x-goog-api-key'] = this.config.geminiApiKey;\n          }\n          const generationConfig: any = {\n            temperature: this.config.temperature,\n          };\n\n          // 最大トークン数制限を使用する場合のみ追加\n          if (this.config.useMaxTokens) {\n            generationConfig.maxOutputTokens = this.config.maxTokens;\n          }\n\n          requestBody = {\n            contents: [\n              {\n                parts: [\n                  {\n                    text: `${prompt.systemPrompt}\\n\\n${userPrompt}`\n                  }\n                ]\n              }\n            ],\n            generationConfig\n          };\n          break;\n\n        default:\n          throw new Error(`Unsupported provider: ${this.config.provider}`);\n      }\n\n      console.log('Making request to:', url);\n      console.log('Request body:', JSON.stringify(requestBody, null, 2));\n\n      const response = await fetch(url, {\n        method: 'POST',\n        headers,\n        body: JSON.stringify(requestBody),\n        signal: AbortSignal.timeout(this.config.timeout),\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      let content = '';\n\n      // プロバイダー別のレスポンス解析\n      switch (this.config.provider) {\n        case 'lm-studio':\n        case 'ollama':\n        case 'azure-openai':\n          content = data.choices?.[0]?.message?.content;\n          break;\n        case 'gemini':\n          content = data.candidates?.[0]?.content?.parts?.[0]?.text;\n          break;\n      }\n\n      if (!content) {\n        throw new Error('LLMからの応答が空です');\n      }\n\n      console.log('LLM Response:', content);\n\n      // JSON解析\n      let gradingResult: LLMGradingResponse;\n      try {\n        // ```json ``` で囲まれている場合の処理\n        const jsonMatch = content.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n        if (jsonMatch) {\n          gradingResult = JSON.parse(jsonMatch[1]);\n        } else {\n          gradingResult = JSON.parse(content);\n        }\n      } catch (parseError) {\n        // JSONパースに失敗した場合、正規表現でマニュアル抽出を試みる\n        gradingResult = this.extractGradingFromText(content);\n      }\n\n      // 結果の検証\n      this.validateGradingResponse(gradingResult, subQuestion.maxScore);\n\n      return gradingResult;\n    } catch (error) {\n      console.error('LLM採点に失敗:', error);\n\n      if (error instanceof Error) {\n        if (error.name === 'AbortError') {\n          throw new Error('採点がタイムアウトしました');\n        }\n        throw new Error(`採点処理でエラーが発生しました: ${error.message}`);\n      }\n\n      throw new Error('採点処理で不明なエラーが発生しました');\n    }\n  }\n\n  // テキストから採点結果を抽出（JSONパース失敗時のフォールバック）\n  private extractGradingFromText(text: string): LLMGradingResponse {\n    console.log('Extracting from text:', text);\n\n    // 複数パターンでスコアを検索\n    const scorePatterns = [\n      /[\"']?score[\"']?\\s*:\\s*[\"']([○△×])[\"']/,\n      /score\\s*:\\s*([○△×])/,\n      /([○△×])/,\n      /grade\\s*:\\s*([○△×])/\n    ];\n\n    const pointsPatterns = [\n      /[\"']?points?[\"']?\\s*:\\s*(\\d+)/,\n      /points?\\s*:\\s*(\\d+)/,\n      /(\\d+)\\s*points?/,\n      /score:\\s*(\\d+)/\n    ];\n\n    const reasonPatterns = [\n      /[\"']?reason[\"']?\\s*:\\s*[\"']([^\"']+)[\"']/,\n      /reason\\s*:\\s*(.+?)(?:\\n|$)/,\n      /because\\s*:\\s*(.+?)(?:\\n|$)/,\n      /explanation\\s*:\\s*(.+?)(?:\\n|$)/\n    ];\n\n    let scoreMatch = null;\n    for (const pattern of scorePatterns) {\n      scoreMatch = text.match(pattern);\n      if (scoreMatch) break;\n    }\n\n    let pointsMatch = null;\n    for (const pattern of pointsPatterns) {\n      pointsMatch = text.match(pattern);\n      if (pointsMatch) break;\n    }\n\n    let reasonMatch = null;\n    for (const pattern of reasonPatterns) {\n      reasonMatch = text.match(pattern);\n      if (reasonMatch) break;\n    }\n\n    if (!scoreMatch) {\n      console.error('No score found in text:', text);\n      throw new Error('採点結果のスコアを抽出できませんでした');\n    }\n\n    return {\n      score: scoreMatch[1] as '○' | '△' | '×',\n      points: pointsMatch ? parseInt(pointsMatch[1], 10) : 5,\n      reason: reasonMatch ? reasonMatch[1].trim() : '採点理由を抽出できませんでした',\n    };\n  }\n\n  // 採点結果の妥当性検証\n  private validateGradingResponse(response: LLMGradingResponse, maxScore: number): void {\n    if (!['○', '△', '×'].includes(response.score)) {\n      throw new Error(`無効なスコア: ${response.score}`);\n    }\n\n    if (typeof response.points !== 'number' || response.points < 0 || response.points > maxScore) {\n      throw new Error(`無効な点数: ${response.points} (最大: ${maxScore})`);\n    }\n\n    if (!response.reason || typeof response.reason !== 'string' || response.reason.length === 0) {\n      throw new Error('採点理由が無効です');\n    }\n\n    // 点数とスコアの整合性チェック\n    const pointPercentage = (response.points / maxScore) * 100;\n\n    if (response.score === '○' && pointPercentage < 80) {\n      console.warn(`スコア○だが点数が低い: ${response.points}/${maxScore} (${pointPercentage.toFixed(1)}%)`);\n    } else if (response.score === '△' && (pointPercentage < 50 || pointPercentage >= 80)) {\n      console.warn(`スコア△だが点数が範囲外: ${response.points}/${maxScore} (${pointPercentage.toFixed(1)}%)`);\n    } else if (response.score === '×' && pointPercentage >= 50) {\n      console.warn(`スコア×だが点数が高い: ${response.points}/${maxScore} (${pointPercentage.toFixed(1)}%)`);\n    }\n  }\n\n  // バッチ採点（複数回答の一括処理）- 将来実装予定\n  async gradeBatch(\n    _questions: Question[],\n    _answers: Answer[],\n    _onProgress?: (current: number, total: number) => void\n  ): Promise<LLMGradingResponse[]> {\n    // TODO: 新しいIPA構造に対応した実装が必要\n    throw new Error('バッチ採点機能は現在開発中です');\n  }\n\n  // 採点一貫性チェック（同じ回答を複数回採点して比較）\n  async checkConsistency(subQuestion: SubQuestion, answer: Answer, iterations: number = 3): Promise<{\n    results: LLMGradingResponse[];\n    isConsistent: boolean;\n    variance: number;\n  }> {\n    const results: LLMGradingResponse[] = [];\n\n    for (let i = 0; i < iterations; i++) {\n      const result = await this.gradeAnswer(subQuestion, answer);\n      results.push(result);\n\n      // 呼び出し間隔\n      if (i < iterations - 1) {\n        await new Promise(resolve => setTimeout(resolve, 500));\n      }\n    }\n\n    // 点数のばらつきを計算\n    const points = results.map(r => r.points);\n    const average = points.reduce((sum, p) => sum + p, 0) / points.length;\n    const variance = points.reduce((sum, p) => sum + Math.pow(p - average, 2), 0) / points.length;\n\n    // 一貫性判定（標準偏差が配点の10%以下なら一貫している）\n    const standardDeviation = Math.sqrt(variance);\n    const isConsistent = standardDeviation <= (subQuestion.maxScore * 0.1);\n\n    return {\n      results,\n      isConsistent,\n      variance,\n    };\n  }\n}\n\nexport const llmService = new LLMService({\n  provider: 'lm-studio',\n  endpoint: 'http://127.0.0.1:1234/v1',\n  model: 'gemma-3n-e4b-it-text',\n  temperature: 0.1,\n  maxTokens: 500,\n  useMaxTokens: true,\n  timeout: 120000\n});"],"names":["DB_NAME","STORES","STORAGE_KEYS","DataService","resolve","reject","request","event","db","examStore","questionStore","answerStore","storeName","operation","store","exam","question","id","questions","exams","examsWithQuestions","answers","answer","examId","studentId","gradingResult","result","answerId","config","configStr","settings","settingsStr","storeNames","key","dataService","LLMService","error","response","model","subQuestion","systemPrompt","questionContext","answerToGrade","prompt","userPrompt","url","headers","requestBody","generationConfig","data","content","jsonMatch","text","scorePatterns","pointsPatterns","reasonPatterns","scoreMatch","pattern","pointsMatch","reasonMatch","maxScore","pointPercentage","_questions","_answers","_onProgress","iterations","results","i","points","r","average","sum","p","variance","isConsistent","llmService"],"mappings":"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"}